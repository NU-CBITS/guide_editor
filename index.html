<html>
<head>
<title>Guide Editor</title>

<!-- <link rel="stylesheet" href="css/jquery-ui.css" /> -->
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" href="bootstrap/css/bootstrap-responsive.min.css" />
<link rel="stylesheet" href="font_awesome/css/font-awesome.css">
<link rel="stylesheet" href="css/global.css" />

<style type="text/css">
  input#private_url { width: 80%; }

  .choose_element:hover { 
    cursor: hand; 
    cursor: pointer; 
  }

  div.collection_widget .elements {
    display:table;
    width:100%;
  }

  div.collection_widget .elements div.action.element {
/*    display:table-row;*/
  }

  div.collection_widget .elements div.edit_container div.action {
    display:table-row;
  }

  div.collection_widget div.elements div.edit_container div.action span.cell{
    display:table-cell;
    margin:0 auto;
  }

</style>

<script type="text/javascript" src="config.js"></script>
<script language="Javascript" src="js/vendor/state-machine.min.js"></script>
<script language="Javascript" src="js/vendor/jquery-1.8.2.js"></script>
<script language="Javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
<!-- <script language="Javascript" src="http://code.jquery.com/jquery-migrate-1.0.0.js"></script> -->
<script language="Javascript" src="bootstrap/js/bootstrap.min.js"></script>
<script language="Javascript" src="js/vendor/underscore-1.4.4.dev.js"></script>
<script language="Javascript" src="js/vendor/backbone-0.9.9.dev.js"></script>
<script language="Javascript" src="js/vendor/knockout-2.2.min.js"></script>

<script language="Javascript" src="wysihtml5/parser_rules/advanced.js"></script>
<script language="Javascript" src="wysihtml5/dist/wysihtml5-0.3.0.min.js"></script>


<script language="Javascript" src="dynamo/vendor/tee.js"></script>
<script language="Javascript" src="ckeditor/ckeditor.js"></script>

<script type="text/javascript" src="dynamo/Core.js"></script>
<script type="text/javascript"> Dynamo.TriremeURL = Config.TriremeURL; </script>
<script type="text/javascript" src="dynamo/Core.Models.js"></script>
<script type="text/javascript"> Dynamo.XelementClass = eval(Config.DynamoXelementClass); </script>
<script type="text/javascript" src="dynamo/Core.Collections.js"></script>
<script type="text/javascript" src="dynamo/Core.Views.js"></script>


<script type="text/javascript" src="dynamo/Guides.Models.js"></script>
<script type="text/javascript" src="dynamo/Guides.Collections.js"></script>
<script type="text/javascript" src="dynamo/Guides.Views.js"></script>
<script type="text/javascript" src="js/initial_load.js"></script>

<script type="text/javascript" language="javascript">

Dynamo.AUTHENTICATING_USER_ID = function() { return "TEST-USER-GUID" };
Dynamo.CurrentUser = function() { 
  return (
    new Dynamo.User({
      guid: Config.CurrentUserGuid,
      group_id: Config.CurrentGroupGuid,
      username: Config.CurrentUsername
    })
  );
};

addGuideActionPluginToCKE = function() {

  CKEDITOR.plugins.add( 'guide_action', {

    // Register the icons.
    icons: 'guide_action',

    // The plugin initialization logic goes inside this method.
    init: function( editor ) {

      // Register our dialog file. this.path is the plugin folder path.
      CKEDITOR.dialog.add( 'guideActionDialog', function( editor ) {
          
          return {
              title: 'Create a Guide Action',
              width:300,
              height: 400,
              minWidth: 300,
              minHeight: 400,
              contents: [
                  {
                      id: 'props',
                      label: 'Button Properties',
                      elements: [
                          {
                              id: 'button_text',
                              label: 'Button Text',
                              type: 'text',
                              validate: CKEDITOR.dialog.validate.notEmpty( "Abbreviation field cannot be empty" )
                          },
                          {
                              id: 'action',
                              label: 'Button Action',
                              type: 'select',
                              options: ['blind', 'bounce', 'clip', 'drop', 'explode', 'fade', 'fold', 'highlight', 'puff', 'pulsate', 'scale', 'shake', 'size', 'slide', 'transfer' ],
                          }
                      ]
                  }
              ],
              onOk: function() {
                  var dialog = this;

                  var button = editor.document.createElement('button', {
                      id: _.uniqueId('action-'),
                      class: "guide-action",
                      "data-action": dialog.getValueOf( 'props', 'action' )
                  });
                  button.setText( dialog.getValueOf( 'props', 'button_text' ) );
                  editor.insertElement( button );
              }
          };

      }); // dialog.add

      debugger;
      // Define an editor command that opens our dialog.
      editor.addCommand( 'guide_action', new CKEDITOR.dialogCommand( 'guideActionDialog' ) );

      // Create a toolbar button that executes the above command.
      editor.ui.addButton( 'GuideAction', {

        // The text part of the button (if available) and tooptip.
        label: 'Insert A Guide-Action Button',

        // The command to execute on click.
        command: 'guide_action',

        // The button placement in the toolbar (toolbar group name).
        toolbar: 'insert'
      });

      debugger;

    } // init

  }); // plugins.add

}; //addGuideActionPluginToCKE

loadPage = function() {

  guides_list = new Dynamo.ChooseOneXelementFromCollectionView({
    el: "div#guides_index",
    collection: GUIDES,
    canCreateNew: true,
    xelement_type: 'guide'
  });

  GUIDES.on("add", guides_list.render);
  GUIDES.on("remove", guides_list.render);

  guides_list.on("element:chosen", function() {

    //Clear cruft    
    $( "div#current-guide" ).empty();
    $( "div#current-slide").empty();
    
    $( "div#iframe-container").find("iframe#guided-page").contents().empty();
    if  ( !_.isUndefined(window.CurrentGuide) && 
          _.isObject(CurrentGuide) && 
          CurrentGuide.stopPeriodicSaving
        ) {
      CurrentGuide.stopPeriodicSaving();
      CurrentGuide = null;  
    };

    // Start handling newly chosen guide:
    CurrentGuide = guides_list.chosen_element;

    // Save New Guides Immediately & Add them to the guides list.
    if (  CurrentGuide.isNew() && !_.contains(guides_list.collection, CurrentGuide) ) {
      CurrentGuide.once("sync", function() {
        guides_list.collection.add(CurrentGuide);
        guides_list.render();
      })
      CurrentGuide.save();
    };

    // Initiate Automatic Saving:
    CurrentGuide.saveOnChange();
    // CurrentGuide.on('periodic_save:suggested', CurrentGuide.save);
    // CurrentGuide.startPeriodicSaving(5); //check to save every 5 seconds.
    CurrentGuide.on('change:title', guides_list.render);

    editGuideView = null;
    editGuideView = new Dynamo.EditGuideView({
      model: CurrentGuide,
      iframe_selector: "iframe#guided-page"
    });

    editGuideView.on("guided_page:loaded", function() {
      $( "div#iframe-container").resizable({ alsoResize: "iframe#guided-page" });
      _.each(editGuideView.usableElements, function(el, i) {
        if ( typeof(editSlideView) !== "undefined" && editSlideView.options) {
          editSlideView.options.actionTargets = editGuideView.usableElements;
          editSlideView.render();
        };
      });
    });

    editGuideView.on("slide:chosen", function() {

      //To ensure that content won't get lost on slide change:
      //causing bug?
      if (  (typeof(editSlideView) !== "undefined") && 
            editSlideView &&
            (editSlideView.$el.find('textarea.slide-content:first').length > 0)//if an element currently exists
          ) {
        
        editSlideView.recordSlideContent();
      }
      
      if (typeof(editSlideView) !== "undefined" && editSlideView && editSlideView.model) {
        editSlideView.remove();
        editSlideView = null;
      }
      
      editSlideView = new Dynamo.EditSlideView({
        guidedPageSelector: editGuideView.options.iframe_selector,
        model: editGuideView.current_slide,
        actionTemplate: DIT["dynamo/guides/slides/actions/edit"],
        actionTargets: _.map(editGuideView.usableElements, function(el) {
          var r = el.tagName; 
          if (el.idName) { r = r+"#"+el.idName };
          if (el.className) { r = r+"."+(el.className.split(' ')).join('.') };
          return r;
        }),
        instantiateEditorFn: function(options, thisView) {
          var e;
          e = CKEDITOR.replace(options.selector, options.ckEditorConfig);
          e.on("instanceReady", function() {
            var bbView = thisView;
            bbView.recordSlideContent = function() {
              bbView.updateContent( e.getData() );
            }
            e.setData(bbView.model.get_field_value("content"));
            this.document.on("keyup", function() {
              bbView.recordSlideContent()
            });
            this.document.on("mouseup", function() {
              bbView.recordSlideContent()
            });
            this.document.on("change", function() {
              bbView.recordSlideContent()
            });            
          });
          return e;
        },
        instantiateEditorOptions: function() {
          return {
            ckEditorConfig: {
              extraPlugins: 'oembed'
            } 
          }
        }
      });


      $("div#current-slide").append(editSlideView.$el);
      editSlideView.render();

    });
    
    $( "div#current-guide" ).append(editGuideView.render().$el);

  });


  guides_list.render();

};

$(window).load(function() {
  
  Dynamo.initialize();
  initializeLoadAndThen(loadPage);
  $("#iframe-container").hide();
  $("#slide-container").draggable({ handle: "div.drag-handle" });

});

// Load guides from Mongo;
// New guide form allows import from Google Doc.
// Selecting a guide loads it in the editor.
// Referrent Page loads in the Iframe;
// - Page title

</script>
</head>
<body>
  <div class="container-fluid" style="padding-top:20px;">
    <h1>Guide Editor</h1>

    <div class="row-fluid">

      <div class="span6">
        <div id="guides_index"></div>
        <div id="slide-container" class="widget" style="z-index:1000;">
          <div class="widget-header widget-header-default drag-handle">
            <h3 class="h2-move" style="display: block;">
              Current Slide
              <i class="icon-move pull-right"></i>
            </h3>
            <div id="current-slide" class='widget-content'></div>
          </div>
        </div>
      </div>

      <div class="span6">
        <div id="guide-container" class="widget">
        <div class="widget-header widget-header-default">
          <h3>Current Guide</h3>
        </div>
        <div id="current-guide" class="widget-content"></div>
        </div>
      </div>
    </div>
    <div id="iframe-container" class="connect-modal" style="z-index:999;">
      <iframe id="guided-page"></iframe>
    </div>
    <h2><span class="h2-header" id="elements_title"></span></h2>
    <div class="clearfix"></div>
    <div id="available_elements"></div>
  </div>

</body>
</html>